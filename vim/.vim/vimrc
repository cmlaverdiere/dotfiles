" Chris Laverdiere's vimrc
" Requires: plug.vim

" TODO editorconfig
" TODO https://github.com/phelipetls/jsonpath.nvim

" Shell compatibility settings.
set shell=bash
set background=dark
set nocompatible

" History settings
set history=10000

" Buffer settings
set hidden

" Case settings
set ignorecase
set smartcase
set infercase

" Clipboard settings
set clipboard=unnamed

" Search settings
set incsearch
set hlsearch

" Tabbing / Indentation
set expandtab
set tabstop=4
set shiftwidth=4
set smarttab
set autoindent
set textwidth=79
set wildmenu
set wildmode=full
set backspace=indent,eol,start
set viminfo=!,'2000,<50,s10,h,:10000

" Scrolling
set scrolloff=3

" Folds
set foldmethod=indent
set nofoldenable

" Backups
set noswapfile
set backup
set backupdir=~/.vimbak
set undofile
if has('nvim')
    set undodir=~/.nvimundo
else
    set undodir=~/.vimundo
endif

" Man pages
set keywordprg=:Man
let g:ft_man_open_mode = 'vert'

" Spelling / Dictionary
set dictionary=/usr/share/dict/words
au BufNewFile,BufRead *.txt setlocal spell
au BufNewFile,BufRead *.md setlocal spell

" Completion
" set completeopt=longest
set completeopt-=preview

" Misc
set gdefault
set nonumber
set laststatus=1
set scrolloff=3
if !has('nvim')
    set cryptmethod=blowfish2
endif
set timeoutlen=1000
set showcmd
set formatoptions+=jn
set nojoinspaces

" Polyglot
" let g:polyglot_disabled = ['python']

" Plugins (mostly syntax files and motion extensions)
" MVPs: kana, tpope
runtime macros/matchit.vim
runtime ftplugin/man.vim
call plug#begin('~/.vim/plugged')

" Plug 'beyondmarc/opengl.vim', { 'for': ['c', 'cpp'] }
Plug 'tikhomirov/vim-glsl'
" Plug 'fatih/vim-go', { 'for': 'go' }
Plug 'rust-lang/rust.vim', { 'for': 'rust' }
Plug 'racer-rust/vim-racer', { 'for': 'rust' }
Plug 'Rip-Rip/clang_complete', { 'for': ['c', 'cpp'] }
Plug 'SirVer/ultisnips'
Plug 'bps/vim-textobj-python', { 'for': 'python' }
Plug 'julian/vim-textobj-variable-segment'
Plug 'eagletmt/neco-ghc', { 'for': 'haskell' }
" Plug 'honza/vim-snippets'
Plug 'hynek/vim-python-pep8-indent', { 'for': 'python' }
" Plug 'hdima/python-syntax', { 'for': 'python' }
Plug 'itchyny/vim-haskell-indent', { 'for': 'haskell' }
Plug 'jpalardy/vim-slime'
Plug 'junegunn/fzf', { 'dir': '~/.fzf', 'do': './install --all' }
Plug 'junegunn/fzf.vim'
Plug 'junegunn/vim-plug'
Plug 'kana/vim-altr'
Plug 'kana/vim-textobj-entire'
Plug 'kana/vim-textobj-function', { 'for': ['c', 'cpp'] }
Plug 'kana/vim-textobj-user'
Plug 'ledger/vim-ledger', { 'for': 'ledger' }
Plug 'mbbill/undotree'
Plug 'mhinz/vim-grepper'
Plug 'michaeljsmith/vim-indent-object'
Plug 'milkypostman/vim-togglelist'
Plug 'nelstrom/vim-visual-star-search'
Plug 'tommcdo/vim-lion'
Plug 'tpope/vim-fugitive'
Plug 'tpope/vim-abolish'
Plug 'tpope/vim-commentary'
Plug 'tpope/vim-repeat'
Plug 'tpope/vim-surround'
Plug 'tpope/vim-unimpaired'
Plug 'tpope/vim-sleuth'
Plug 'triglav/vim-visual-increment'
Plug 'wellle/targets.vim'
" Plug 'nelstrom/vim-markdown-folding'
Plug 'w0rp/ale'
Plug 'editorconfig/editorconfig-vim'
Plug 'sheerun/vim-polyglot'
Plug 'vimwiki/vimwiki'
Plug 'junegunn/vim-easy-align'
Plug 'freitass/todo.txt-vim'
Plug 'tommcdo/vim-exchange'
" Plug 'plasticboy/vim-markdown'
" Plug 'dkarter/bullets.vim'
Plug 'davidhalter/jedi-vim', { 'for': 'python' }
Plug 'preservim/nerdtree'
if has('nvim')
    Plug 'nvim-treesitter/nvim-treesitter', {'do': ':TSUpdate'}
    Plug 'nvim-treesitter/playground'
    Plug 'neovim/nvim-lspconfig'
    Plug 'ellisonleao/gruvbox.nvim'
    Plug 'b0o/SchemaStore.nvim'
    Plug 'luukvbaal/stabilize.nvim'
    Plug 'nvim-lua/plenary.nvim'
    Plug 'sindrets/diffview.nvim'
    Plug 'kyazdani42/nvim-web-devicons'
    Plug 'kyazdani42/nvim-tree.lua'
    Plug 'ruifm/gitlinker.nvim'
    Plug 'rktjmp/lush.nvim'
    Plug 'mcchrish/zenbones.nvim'
    Plug 'folke/trouble.nvim'
    Plug 'jose-elias-alvarez/null-ls.nvim'
    Plug 'MunifTanjim/nui.nvim'
    Plug 'nvim-telescope/telescope.nvim'
    Plug 'jackMort/ChatGPT.nvim'
    Plug 'dpayne/CodeGPT.nvim'
else
    Plug 'morhetz/gruvbox'
endif

call plug#end()

filetype plugin indent on
syntax on

" Critical remaps
map <Space> <Leader>
nnoremap Y y$
inoremap jk <esc>
nnoremap ' `
nnoremap ` '
nnoremap - :Ex<CR>

" Repeat maps
vnoremap . :normal .<CR>
xnoremap @q :normal @q<CR>

" Execute maps
:vnoremap <Leader>e :<c-u>exe join(getline("'<","'>"),'<bar>')<cr>

" Spelling maps
inoremap <C-y> <c-g>u<Esc>[s1z=`]a<c-g>u
nnoremap <C-y> [s1z=<c-o>

" Mouse scrolling
set mouse=a

" Window resize maps
nnoremap <Left> 5<C-w><
nnoremap <Right> 5<C-w>>
nnoremap <Up> 5<C-w>-
nnoremap <Down> 5<C-w>+

" Window movement maps
noremap <C-h> <C-w>h
noremap <C-j> <C-w>j
noremap <C-k> <C-w>k
noremap <C-l> <C-w>l
inoremap <C-h> <esc><C-w>h
inoremap <C-j> <esc><C-w>j
inoremap <C-k> <esc><C-w>k
inoremap <C-l> <esc><C-w>l

" Misc maps
nnoremap <silent> dsa ds}dF\
inoremap <C-]> {<CR>}<esc>O
imap <c-x><c-g> <plug>(fzf-complete-path)
nnoremap gK :!cppman <C-r><C-w><CR>

" Commands
function! s:EditSameDir(filename)
    let l:newfile = expand('%:p:h') . '/' . a:filename
    execute 'edit' l:newfile
endfunction
command! -nargs=1 E call s:EditSameDir(<f-args>)

" Leader Mappings
nmap <Leader>ga <Plug>(altr-forward)
nnoremap <Leader>aes :s/\(\w\)/\U\1 <CR>:nohl<CR>
nnoremap <Leader>C :BCommits<CR>
nnoremap <Leader>T :!ctags -R<CR><CR>
nnoremap <Leader>V :sp<CR>
nnoremap <Leader>asc ggVG:Tab /;<CR>
nnoremap <Leader>bb :FZFBuffers<CR>
nnoremap <Leader>bd :bd<CR>
" nnoremap <Leader>c :make -j9<CR>
nnoremap <Leader>ct :!com2ann %<CR>:e<CR>
nnoremap <Leader>d2 :windo diffthis<CR>
nnoremap <Leader>do :diffoff<CR>
nnoremap <Leader>ea :EnableAutoread<CR>
nnoremap <Leader>fed :e ~/.vim/vimrc<CR>
nnoremap <Leader>fet :e ~/Documents/todo/todo.txt<CR>
nnoremap <Leader>fl :FZFFiles ~/<CR>
nnoremap <leader>fb :NERDTreeFocus<CR>
nnoremap <leader>fp :let @+ = expand("%")<CR>
nnoremap <Leader>fs :w<CR>
nnoremap <Leader>fmt :g/.*/norm gqqo<CR>:nohl<CR>gg
nnoremap <Leader>gb :Git blame<CR>
nnoremap <Leader>gd :Gdiff HEAD<CR>
nnoremap <Leader>gl :Git log<CR>
nnoremap <Leader>gp :Git push<CR>
nnoremap <Leader>gs :Git<CR>
nnoremap <Leader>gcc :!gcc -g -std=c99 % -o %< && ./%<<CR>
nnoremap <Leader>gpp :!g++ -g -std=c++11 % -o %< && ./%<<CR>
vnoremap <Leader>gpto :!python3 ~/dev/gpt/gptify obfuscate<CR>
vnoremap <Leader>gptd :!python3 ~/dev/gpt/gptify deobfuscate<CR>
nnoremap <Leader>mt :make -j9 tests<CR>
nnoremap <Leader>pc :set paste<CR>p:set nopaste<CR>
nnoremap <Leader>pf :FZFGFiles<CR>
nnoremap <Leader>pg :FZFFiles<CR>
nnoremap <Leader>pt :FZFTags<CR>
nnoremap <Leader>pr :FZFHistory<CR>
nnoremap <Leader>pi :PlugInstall<CR>
xnoremap <Leader>pr "ay :norm gvgs<CR> \| :cfdo :%s/<c-r>a//ce<left><left><left>
nnoremap <Leader>py :!python %<CR>
nnoremap <Leader>q :q!<CR>
nnoremap <Leader>rl :so $MYVIMRC<CR>
nnoremap <Leader>se :UltiSnipsEdit<CR>
nnoremap <Leader>sh :.w !bash<CR>
nnoremap <Leader>sn :FZFSnippets<CR>
nnoremap <Leader>sp :Grepper -query ""<left>
nnoremap <Leader>S :sort<CR>
xnoremap <Leader>S :sort<CR>
nnoremap <Leader>o :FZFBLines<CR>
nnoremap <Leader>ta vip!pandoc -t markdown<CR>
nnoremap <Leader>tc :tabclose<CR>
nnoremap <Leader>tn :tabnew<CR>
nnoremap <Leader>toc :VimwikiTOC<CR>
nnoremap <Leader><F13> <Plug>VimwikiRemoveHeaderLevel
nnoremap <Leader>ts :ALEToggle<CR>
nnoremap <Leader>tr :%s/\s*$//g<CR><C-o>zz
nnoremap <Leader>u :UndotreeToggle<CR>:UndotreeFocus<CR>
nnoremap <Leader>v :vs<CR>
nnoremap <Leader>= :ALEFix<CR>
nnoremap <script> <silent> <leader>el :call ToggleQuickfixList()<CR>
nnoremap <silent> <Leader>. :FZFRg <C-R><C-W><CR>
nnoremap <silent> <Leader>/ :FZFRg <CR>
nnoremap <silent> <Leader>? :FilteredFZFRg<CR>
nnoremap <silent> <Leader>: :FZFCommands<CR>
nnoremap <silent> <Leader>sc :nohlsearch<CR>
noremap <Leader>G :Google<CR>
" nnoremap <silent> g
"     \ :ALEGoToDefinition<CR>

set pastetoggle=<Leader>pt

" Remove trailing whitespace function.
fun! RTW()
  let l = line(".")
  let c = col(".")
  %s/\s\+$//e
  call cursor(l, c)
endfun
command! RTW call RTW()

fun! EnableAutoread()
    set autoread
    set shortmess+=Ot
    set cmdheight=2
endfun
command! EnableAutoread call EnableAutoread()

" ALE
" TODO find how to use compile_commands.json for this. Submit issue asking.
let g:ale_enabled = 0
let g:ale_set_quickfix = 1
let g:ale_lint_on_text_changed = 0
let g:ale_lint_on_save = 1
let g:ale_lint_on_enter = 0
let g:ale_python_pylint_use_global = 1
let g:ale_python_black_options = "--line-length 120 -t py27"
let g:ale_python_black_executable = "/Users/chris.laverdiere/venv3/bin/black"
" let g:ale_typescript_tsserver_use_global=1
" TODO Get html linter working.
let g:ale_linters = {
\   'cpp': ['clangtidy'],
\   'yaml': ['yamllint'],
\}
" \   'python': ['pylint', 'flake8'],
" TODO Get html fixer working.
let g:ale_fixers = {
\   '*': ['remove_trailing_lines', 'trim_whitespace'],
\   'javascript': ['prettier'],
\   'html': ['prettier'],
\   'typescript': ['prettier'],
\   'typescriptreact': ['prettier'],
\   'json': ['jq'],
\   'python': ['black', 'isort'],
\   'rust': ['rustfmt'],
\   'sql': ['pgformatter'],
\   'sh': ['shfmt'],
\}
let g:ale_sign_error = '✘'
let g:ale_sign_warning = '⚠'
highlight ALEErrorSign ctermbg=NONE ctermfg=red
highlight ALEWarningSign ctermbg=NONE ctermfg=yellow

" FZF
let g:fzf_command_prefix = 'FZF'
let g:fzf_preview_window = ['up', 'ctrl-/']
command! -bang -nargs=* FZFRg
  \ call fzf#vim#grep(
  \   'rg --follow --column --line-number --no-heading --color=always '.shellescape(<q-args>), 1,
  \   <bang>0 ? fzf#vim#with_preview('up:60%')
  \           : fzf#vim#with_preview('right:50%:hidden', '?'),
  \   <bang>0)

function! FilteredFZFRg(fullscreen)
  let filepaths = input('File pattern: ', "", "file")
  let command_fmt = 'rg --column --line-number --no-heading --color=always --smart-case --with-filename -e ''%s'' ' . filepaths . ' || true'
  let initial_command = printf(command_fmt, '')
  let reload_command = printf(command_fmt, '{q}')
  let spec = {'options': ['--phony', '--bind', 'change:reload:'.reload_command]}
  call fzf#vim#grep(initial_command, 1, fzf#vim#with_preview(spec), a:fullscreen)
endfunction
command! -nargs=* -complete=file -bang FilteredFZFRg call FilteredFZFRg(<bang>0)

let g:fzf_action = {
  \ 'ctrl-v': 'vsplit',
  \ 'ctrl-q': 'fill_quickfix'}

" Haskell
au FileType haskell nnoremap <buffer> <Leader>T :!hasktags .<CR><CR>
au FileType haskell setlocal omnifunc=necoghc#omnifunc
au FileType haskell setlocal makeprg=ghc\ -e\ :q\ %
au FileType haskell setlocal errorformat=
                \%-G,
                \%-Z\ %#,
                \%W%f:%l:%c:\ Warning:\ %m,
                \%E%f:%l:%c:\ %m,
                \%E%>%f:%l:%c:,
                \%+C\ \ %#%m,
                \%W%>%f:%l:%c:,
                \%+C\ \ %#%tarning:\ %m,

" Vim-grepper
let g:grepper = {'tools': ['rg', 'ag'], 'open': 0, 'jump': 0, 'prompt': 0}
nmap gs <plug>(GrepperOperator)
xmap gs <plug>(GrepperOperator)

" Toggle list
let g:toggle_list_no_mappings = 1

" Bullets
let g:bullets_enable_in_empty_buffers = 0
" let g:bullets_delete_last_bullet_if_empty = 0
" let g:bullets_line_spacing = 2
let g:bullets_pad_right = 0
let g:bullets_outline_levels = ['ROM', 'ABC', 'num', 'abc', 'rom', 'std-', 'std-', 'std-']

" Clang-format
au Filetype c,cpp nnoremap <buffer> <leader>= mmggvG:!clang-format<CR>'m
au Filetype c,cpp xnoremap <buffer> <leader>= :!clang-format<CR>

" Clang complete (for c/c++)
let g:clang_library_path='/usr/lib'
let g:clang_complete_auto=0
let g:clang_user_options = '-std=c++11'
let g:clang_complete_macros=1
let g:clang_make_default_keymappings=0
if !empty(glob('./build/compile_commands.json'))
    let g:clang_use_library=1
    let g:clang_auto_user_options = 'compile_commands.json, .clang_complete, path'
    let g:clang_compilation_database = './build'
    call system("cp ./build/compile_commands.json .")
    set makeprg=ninja\ -C\ build
endif
au Filetype c,cpp nnoremap <silent> <buffer> g
    \ :call g:ClangGotoDeclaration()<CR>

" Cpp highlighting
let g:cpp_class_scope_highlight = 1

" Python: use pydoc for man-pages
" au FileType python setlocal keywordprg=pydoc
au FileType python setlocal makeprg=pylint\ -r\ n\ -f\ parseable\ %
au FileType python setlocal textwidth=120

" Python jedi
let g:jedi#auto_initialization = 0
let g:jedi#show_call_signatures = 0
aug jedi_group
    au!
    " au Filetype python call jedi#configure_call_signatures()
    au Filetype python setlocal omnifunc=jedi#completions
    au Filetype python nnoremap <silent> <buffer> K
        \ :call jedi#show_documentation()<CR>
    au Filetype python nnoremap <silent> <buffer> g
        \ :call jedi#goto()<CR>
    au Filetype python nnoremap <silent> <buffer> <leader>fu
        \ :call jedi#usages()<CR>
    au Filetype python nnoremap <silent> <buffer> <leader>rf
        \ :call jedi#rename()<CR>
aug END

au Filetype python nnoremap <buffer> <leader>db mmOimport pdb; pdb.set_trace()'m

" Rust racer
let g:racer_no_default_keymappings = 1
let g:racer_cmd = "/Users/thrash/.cargo/bin/racer"
aug rust_group
    au!
    au Filetype rust compiler rustc
    au Filetype rust nmap <buffer> g <Plug>(rust-def)
    au Filetype rust nmap <buffer> K <Plug>(rust-doc)
    au Filetype rust let g:ale_rust_cargo_use_clippy=1
aug END

" Go
" aug go_group
"     let g:go_fmt_autosave = 0
"     let g:go_def_mapping_enabled = 0
"     let g:go_highlight_space_tab_error = 0
"     let g:go_highlight_trailing_whitespace_error = 0
"     let g:go_highlight_array_whitespace_error = 0
"     au Filetype go nnoremap <buffer> <leader>= :GoFmt<CR>
"     au Filetype go nmap <buffer> <leader>i :GoImports<CR>
"     au Filetype go nmap <buffer> K <Plug>(go-doc-split)
"     au Filetype go nmap <buffer> g <Plug>(go-def)
"     au Filetype go xnoremap <buffer> <leader>= !gofmt<CR>
" aug END

" Markdown compatibility.
let g:vim_markdown_auto_insert_bullets = 0
" au BufNewFile,BufReadPost *.md setlocal filetype=markdown
au BufNewFile,BufReadPost *.md setlocal filetype=vimwiki
" au Filetype markdown setlocal commentstring=[//]:\ #\ (%s)
au Filetype markdown setlocal nospell

" Ultisnips
let g:UltiSnipsSnippetsDir = '~/.vim/UltiSnips/'

" Nerdtree
let g:NERDTreeHijackNetrw = 0

aug prewrite_group
    au!
    " Remove trailing whitespace on save.
    au BufWritePre * :call RTW()
aug END

" Ledger
let g:ledger_align_at = 40
au Filetype ledger nnoremap <buffer> <leader>c :setlocal makeprg=ledger \
            \| make -f % balance<CR>
au Filetype ledger vnoremap <buffer> = :LedgerAlign<CR>

" Vimwiki
" let g:vimwiki_global_ext = 0
let g:vimwiki_list = [{'path': '~/docs/', 'syntax': 'markdown', 'ext': 'md'}]
aug wiki_group
    au Filetype vimwiki set nowrap
    au Filetype vimwiki set spell
aug END

" Slime (for REPLs)
let g:slime_target = 'tmux'
let g:slime_paste_file = '$HOME/.slime_paste'
let g:slime_default_config = {'socket_name': 'default', 'target_pane': '{down-of}'}
let g:slime_no_mappings = 1
let g:slime_dont_ask_default = 1
let g:slime_python_ipython = 1
xmap <leader>s <Plug>SlimeRegionSend
nmap <leader>s <Plug>SlimeMotionSend
nmap <leader>ss <Plug>SlimeLineSend
nmap <leader>sl <Plug>SlimeConfig<CR>

" Vim-slime key mappings
function! SlimeConfig(direction)
  if a:direction == 'h'
    let g:slime_default_config.target_pane = "{left-of}"
  elseif a:direction == 'j'
    let g:slime_default_config.target_pane = "{down-of}"
  elseif a:direction == 'k'
    let g:slime_default_config.target_pane = "{up-of}"
  elseif a:direction == 'l'
    let g:slime_default_config.target_pane = "{right-of}"
  endif
endfunction

nnoremap <silent> <Leader>lh :call SlimeConfig('h')<CR>
nnoremap <silent> <Leader>lj :call SlimeConfig('j')<CR>
nnoremap <silent> <Leader>lk :call SlimeConfig('k')<CR>
nnoremap <silent> <Leader>ll :call SlimeConfig('l')<CR>

" Disable ftplugin-mail maps.
let no_mail_maps=1

" Add to jumplist for multi j/k jumps.
nnoremap <silent> k :<C-U>execute 'normal!'
      \ (v:count > 1 ? "m'" . v:count : '') . 'k'<CR>
nnoremap <silent> j :<C-U>execute 'normal!'
      \ (v:count > 1 ? "m'" . v:count : '') . 'j'<CR>

xmap ga <Plug>(EasyAlign)
nmap ga <Plug>(EasyAlign)

if (has("termguicolors"))
    let &t_8f = "\<Esc>[38;2;%lu;%lu;%lum"
    let &t_8b = "\<Esc>[48;2;%lu;%lu;%lum"
    set termguicolors
endif

" Local config for mac
if exists('python_highlight_all')
    unlet python_highlight_all
endif
if exists('python_space_error_highlight')
    unlet python_space_error_highlight
endif
if exists('python_highlight_space_errors')
    unlet python_highlight_space_errors
endif

" Freed <C-l> in Netrw
nmap <leader><leader><leader><leader><leader><leader>l <Plug>NetrwRefresh

" Hurl ft
au BufRead,BufNewFile *.hurl set filetype=http

" Disable csv mode
au BufRead,BufNewFile *.csv set filetype=txt

" Consul-config repo json override
augroup MyRepoAutocmds
    autocmd!
    autocmd BufRead,BufNewFile ~/go/src/github.com/DataDog/consul-config/** set filetype=json
augroup END

let $BAT_THEME='gruvbox-dark'

set background=dark

" colorscheme gruvbox
autocmd ColorScheme zenwritten lua require "customize_zenbones"
colorscheme zenwritten

" Commands that must be run after everything
set noautoread

set nospell


